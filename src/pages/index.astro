---
import BaseLayout from '../layouts/BaseLayout.astro'
import { getAllAuthors, getAllPosts } from '../lib/content.js'
import siteMetadata from '../data/siteMetadata.js'
import { formatDate, trimString } from '../lib/utils.js'

const POSTS_PER_PAGE = 5
const allPosts = await getAllPosts()
const allAuthors = await getAllAuthors()
const authorMap = new Map(allAuthors.map((author) => [author.slug, author.name]))
const posts = allPosts.slice(0, POSTS_PER_PAGE).map((post) => {
  const authorSlug =
    Array.isArray(post.authors) && post.authors.length > 0 ? post.authors[0] : 'default'

  return {
    ...post,
    authorName: authorMap.get(authorSlug) ?? 'Sentry',
    shortSummary: trimString(post.summary ?? '', 180),
  }
})
---

<BaseLayout title={siteMetadata.title} description={siteMetadata.description}>
  <section class="border-b border-[#dde0ea] pb-14 pt-16 dark:border-[#222222] max-sm:pb-8 max-sm:pt-10">
    <div class="overflow-hidden rounded-md border border-[#d9dbe6] bg-white dark:border-[#222222] dark:bg-[#111111]">
      <div class="flex items-center gap-1.5 border-b border-[#d9dbe6] bg-[#f4f5f8] px-4 py-3 dark:border-[#222222] dark:bg-[#161616] max-[420px]:px-3 max-[420px]:py-2.5">
        <div class="h-2.5 w-2.5 rounded-full bg-[#ff5f56]"></div>
        <div class="h-2.5 w-2.5 rounded-full bg-[#ffbd2e]"></div>
        <div class="h-2.5 w-2.5 rounded-full bg-[#27c93f]"></div>
        <span class="ml-3 text-xs text-gray-400 dark:text-gray-500 max-[420px]:hidden">~/sentry.engineering</span>
      </div>
      <div class="px-6 py-6 max-sm:px-4 max-sm:py-4">
        <div class="mb-1 text-base font-medium text-[#1f2430] dark:text-[#e0e0e0] max-sm:text-xs">
          From the engineers building Sentry.
        </div>
        <div class="mb-1 text-sm text-[#5b6270] dark:text-[#8a8a8a] max-sm:text-xs">
          Deep dives into the systems, SDKs, and infrastructure behind Sentry, and the engineering problems that keep us up at night
        </div>
      </div>
    </div>
  </section>

  <section class="py-12" id="blog">
    <div class="mb-8 flex items-center justify-between">
      <h2 class="text-xs font-normal uppercase tracking-widest text-gray-400 dark:text-gray-500"><span class="text-[#6a5fc1]">#</span> recent posts</h2>
      <span class="text-xs text-gray-400 dark:text-gray-500">{posts.length} {posts.length === 1 ? 'post' : 'posts'}</span>
    </div>

    <div class="flex flex-col gap-px">
      {posts.length === 0 && <p class="text-sm text-[#5b6270] dark:text-[#8a8a8a]">No posts found.</p>}
      {
        posts.map((post) => (
          <a
            href={`/blog/${post.slug}`}
            class="group mb-3 block cursor-pointer rounded border border-[#d9dbe6] bg-white px-6 py-5 text-inherit no-underline transition-colors hover:border-[#c4c9d8] hover:bg-[rgba(106,95,193,0.08)] dark:border-[#222222] dark:bg-[#111111] dark:hover:border-[#333333] dark:hover:bg-[rgba(106,95,193,0.12)] max-sm:px-[1.15rem] max-sm:py-4"
          >
            <div class="mb-3 block">
              <span class="text-sm font-medium leading-[1.7] text-[#1f2430] transition-colors group-hover:text-[#6a5fc1] dark:text-[#e0e0e0] max-sm:text-xs">
                {post.title}
              </span>
            </div>
            <div class="mb-0.5 flex flex-wrap items-center gap-x-5 gap-y-1 text-xs text-gray-400 dark:text-gray-500 max-sm:flex-col max-sm:items-start max-sm:gap-y-1">
              <span class="flex items-center gap-1.5">
                <span class="text-gray-400 dark:text-gray-500">date:</span>
                <span class="text-[#5b6270] dark:text-[#8a8a8a]">{formatDate(post.date, siteMetadata.locale)}</span>
              </span>
              <span class="flex items-center gap-1.5">
                <span class="text-gray-400 dark:text-gray-500">author:</span>
                <span class="text-[#5b6270] dark:text-[#8a8a8a]">{post.authorName}</span>
              </span>
            </div>
            {post.shortSummary && (
              <p class="mt-2 text-sm text-[#5b6270] dark:text-[#8a8a8a]">{post.shortSummary}</p>
            )}
          </a>
        ))
      }
    </div>
  </section>

  {allPosts.length > POSTS_PER_PAGE && (
    <div class="my-4 flex justify-end text-xs">
      <a href="/blog" aria-label="all posts" class="inline-flex items-center text-[#6a5fc1] no-underline transition-opacity hover:opacity-85">
        View all posts &rarr;
      </a>
    </div>
  )}
</BaseLayout>
